#!/usr/bin/env ruby
require 'l10nizer'
require 'yaml'
require 'fileutils'

Dir.chdir(ARGV.first) if ARGV.first
templates = Dir['app/views/**/*.html.{erb,haml}']
raise "Can't find any templates in app/views." unless templates.any?

keygen = L10nizer::KeyGenerator.new
l10ns = {}

def read(path)
  File.read(path)
end

def write(path, content)
  File.open(path, 'w') do |f|
    f << content
  end
end

templates.each do |path|
  $stderr.puts path
  begin
    keygen.namespace = path.split('/')[2]
    source = read(path)
    context = path.match(/\.haml\z/) ? L10nizer::Haml : L10nizer::HtmlErb
    l10nizer = L10nizer::Processor.new(source, keygen, context)
    l10ns.merge!(l10nizer.l10ns)
    write path, l10nizer.reformed
  rescue => e
    $stderr.puts e
  end
end

l10ns = l10ns.inject({}){ |hash, (key, value)|
  parts = key.split('.')
  parts[0..-2].inject(hash) { |h, k| h[k] ||= {} }[parts.last] = value
  hash
}

FileUtils.mkdir_p('config/locales')
File.open('config/locales/l10nized.yml', 'w') do |f|
  f << {'en' => l10ns}.to_yaml
end
